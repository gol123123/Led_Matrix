#include "max7219.h"

#define CS_ACTIVATE()           (GPIOB->ODR &= ~GPIO_ODR_ODR5)
#define CS_DIACTIVATE()         (GPIOB->ODR |= GPIO_ODR_ODR5)
#define EMPTY_DATA              0x00
uint8_t DataNamChar[50];
uint8_t frameBuffer[MAX7219_CHIPS*8];	// ?????? ??? ?????? ????? ?? ?????? ???????

int32_t x = 0;   // ?????????? X
int32_t y = 0;	// ?????????? Y


uint8_t MAX7219_Matrix_font[162][8] = {
{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00} ,  // 0x20, Space // 32 ?????? ?? ASCII	// 0 ???????? ???????
   {0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x04} ,  // 0x21, ! 
   {0x00, 0x09, 0x09, 0x12, 0x00, 0x00, 0x00, 0x00} ,  // 0x22, " 
   {0x00, 0x0a, 0x0a, 0x1f, 0x0a, 0x1f, 0x0a, 0x0a} ,  // 0x23, # 
   {0x00, 0x04, 0x0f, 0x14, 0x0e, 0x05, 0x1e, 0x04} ,  // 0x24, $ 
   {0x00, 0x19, 0x19, 0x02, 0x04, 0x08, 0x13, 0x13} ,  // 0x25, % 
   {0x00, 0x04, 0x0a, 0x0a, 0x0a, 0x15, 0x12, 0x0d} ,  // 0x26, & 
   {0x00, 0x04, 0x04, 0x08, 0x00, 0x00, 0x00, 0x00} ,  // 0x27, ' 
   {0x00, 0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02} ,  // 0x28, ( 
   {0x00, 0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08} ,  // 0x29, ) 
   {0x00, 0x04, 0x15, 0x0e, 0x1f, 0x0e, 0x15, 0x04} ,  // 0x2a, * 
   {0x00, 0x00, 0x04, 0x04, 0x1f, 0x04, 0x04, 0x00} ,  // 0x2b, + 
   {0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x08} ,  // 0x2c, , 
   {0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00} ,  // 0x2d, - 
   {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x0c} ,  // 0x2e, . 
   {0x00, 0x01, 0x01, 0x02, 0x04, 0x08, 0x10, 0x10} ,  // 0x2f, / 
   {0x00, 0x0e, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0e} ,  // 0x30, 0 
   {0x00, 0x04, 0x0c, 0x04, 0x04, 0x04, 0x04, 0x0e} ,  // 0x31, 1 
   {0x00, 0x0e, 0x11, 0x01, 0x02, 0x04, 0x08, 0x1f} ,  // 0x32, 2 
   {0x00, 0x0e, 0x11, 0x01, 0x06, 0x01, 0x11, 0x0e} ,  // 0x33, 3 
   {0x00, 0x02, 0x06, 0x0a, 0x12, 0x1f, 0x02, 0x02} ,  // 0x34, 4 
   {0x00, 0x1f, 0x10, 0x1e, 0x01, 0x01, 0x11, 0x0e} ,  // 0x35, 5 
   {0x00, 0x06, 0x08, 0x10, 0x1e, 0x11, 0x11, 0x0e} ,  // 0x36, 6 
   {0x00, 0x1f, 0x01, 0x02, 0x04, 0x08, 0x08, 0x08} ,  // 0x37, 7 
   {0x00, 0x0e, 0x11, 0x11, 0x0e, 0x11, 0x11, 0x0e} ,  // 0x38, 8 
   {0x00, 0x0e, 0x11, 0x11, 0x0f, 0x01, 0x02, 0x0c} ,  // 0x39, 9 
   {0x00, 0x00, 0x0c, 0x0c, 0x00, 0x0c, 0x0c, 0x00} ,  // 0x3a, : 
   {0x00, 0x00, 0x0c, 0x0c, 0x00, 0x0c, 0x04, 0x08} ,  // 0x3b, ; 
   {0x00, 0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02} ,  // 0x3c, < 
   {0x00, 0x00, 0x00, 0x1f, 0x00, 0x1f, 0x00, 0x00} ,  // 0x3d, = 
   {0x00, 0x08, 0x04, 0x02, 0x01, 0x02, 0x04, 0x08} ,  // 0x3e, > 
   {0x00, 0x0e, 0x11, 0x01, 0x02, 0x04, 0x00, 0x04} ,  // 0x3f, ? 
   {0x00, 0x0e, 0x11, 0x17, 0x15, 0x17, 0x10, 0x0f} ,  // 0x40, @ 
   {0x00, 0x04, 0x0a, 0x11, 0x11, 0x1f, 0x11, 0x11} ,  // 0x41, A 
   {0x00, 0x1e, 0x11, 0x11, 0x1e, 0x11, 0x11, 0x1e} ,  // 0x42, B 
   {0x00, 0x0e, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0e} ,  // 0x43, C 
   {0x00, 0x1e, 0x09, 0x09, 0x09, 0x09, 0x09, 0x1e} ,  // 0x44, D 
   {0x00, 0x1f, 0x10, 0x10, 0x1c, 0x10, 0x10, 0x1f} ,  // 0x45, E 
   {0x00, 0x1f, 0x10, 0x10, 0x1f, 0x10, 0x10, 0x10} ,  // 0x46, F 
   {0x00, 0x0e, 0x11, 0x10, 0x10, 0x13, 0x11, 0x0f} ,  // 0x37, G 
   {0x00, 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x11} ,  // 0x48, H 
   {0x00, 0x0e, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0e} ,  // 0x49, I 
   {0x00, 0x1f, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0c} ,  // 0x4a, J 
   {0x00, 0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11} ,  // 0x4b, K 
   {0x00, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f} ,  // 0x4c, L 
   {0x00, 0x11, 0x1b, 0x15, 0x11, 0x11, 0x11, 0x11} ,  // 0x4d, M 
   {0x00, 0x11, 0x11, 0x19, 0x15, 0x13, 0x11, 0x11} ,  // 0x4e, N 
   {0x00, 0x0e, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e} ,  // 0x4f, O 
   {0x00, 0x1e, 0x11, 0x11, 0x1e, 0x10, 0x10, 0x10} ,  // 0x50, P 
   {0x00, 0x0e, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0d} ,  // 0x51, Q 
   {0x00, 0x1e, 0x11, 0x11, 0x1e, 0x14, 0x12, 0x11} ,  // 0x52, R 
   {0x00, 0x0e, 0x11, 0x10, 0x0e, 0x01, 0x11, 0x0e} ,  // 0x53, S 
   {0x00, 0x1f, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04} ,  // 0x54, T 
   {0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e} ,  // 0x55, U 
   {0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0a, 0x04} ,  // 0x56, V 
   {0x00, 0x11, 0x11, 0x11, 0x15, 0x15, 0x1b, 0x11} ,  // 0x57, W 
   {0x00, 0x11, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x11} ,  // 0x58, X 
   {0x00, 0x11, 0x11, 0x0a, 0x04, 0x04, 0x04, 0x04} ,  // 0x59, Y 
   {0x00, 0x1f, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1f} ,  // 0x5a, Z 
   {0x00, 0x0e, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0e} ,  // 0x5b, [ 
   {0x00, 0x10, 0x10, 0x08, 0x04, 0x02, 0x01, 0x01} ,  // 0x5c, \ 
   {0x00, 0x0e, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0e} ,  // 0x5d, ] 
   {0x00, 0x04, 0x0a, 0x11, 0x00, 0x00, 0x00, 0x00} ,  // 0x5e, ^ 
   {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f} ,  // 0x5f, _ 
   {0x00, 0x04, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00} ,  // 0x60, ` 
   {0x00, 0x00, 0x0e, 0x01, 0x0d, 0x13, 0x13, 0x0d} ,  // 0x61, a 
   {0x00, 0x10, 0x10, 0x10, 0x1c, 0x12, 0x12, 0x1c} ,  // 0x62, b 
   {0x00, 0x00, 0x00, 0x0e, 0x10, 0x10, 0x10, 0x0e} ,  // 0x63, c 
   {0x00, 0x01, 0x01, 0x01, 0x07, 0x09, 0x09, 0x07} ,  // 0x64, d 
   {0x00, 0x00, 0x00, 0x0e, 0x11, 0x1f, 0x10, 0x0f} ,  // 0x65, e 
   {0x00, 0x06, 0x09, 0x08, 0x1c, 0x08, 0x08, 0x08} ,  // 0x66, f 
   {0x00, 0x0e, 0x11, 0x13, 0x0d, 0x01, 0x01, 0x0e} ,  // 0x67, g 
   {0x00, 0x10, 0x10, 0x10, 0x16, 0x19, 0x11, 0x11} ,  // 0x68, h 
   {0x00, 0x00, 0x04, 0x00, 0x0c, 0x04, 0x04, 0x0e} ,  // 0x69, i 
   {0x00, 0x02, 0x00, 0x06, 0x02, 0x02, 0x12, 0x0c} ,  // 0x6a, j 
   {0x00, 0x10, 0x10, 0x12, 0x14, 0x18, 0x14, 0x12} ,  // 0x6b, k 
   {0x00, 0x0c, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04} ,  // 0x6c, l 
   {0x00, 0x00, 0x00, 0x0a, 0x15, 0x15, 0x11, 0x11} ,  // 0x6d, m 
   {0x00, 0x00, 0x00, 0x16, 0x19, 0x11, 0x11, 0x11} ,  // 0x6e, n 
   {0x00, 0x00, 0x00, 0x0e, 0x11, 0x11, 0x11, 0x0e} ,  // 0x6f, o 
   {0x00, 0x00, 0x1c, 0x12, 0x12, 0x1c, 0x10, 0x10} ,  // 0x70, p 
   {0x00, 0x00, 0x07, 0x09, 0x09, 0x07, 0x01, 0x01} ,  // 0x71, q 
   {0x00, 0x00, 0x00, 0x16, 0x19, 0x10, 0x10, 0x10} ,  // 0x72, r 
   {0x00, 0x00, 0x00, 0x0f, 0x10, 0x0e, 0x01, 0x1e} ,  // 0x73, s 
   {0x00, 0x08, 0x08, 0x1c, 0x08, 0x08, 0x09, 0x06} ,  // 0x74, t 
   {0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d} ,  // 0x75, u 
   {0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x0a, 0x04} ,  // 0x76, v 
   {0x00, 0x00, 0x00, 0x11, 0x11, 0x15, 0x15, 0x0a} ,  // 0x77, w 
   {0x00, 0x00, 0x00, 0x11, 0x0a, 0x04, 0x0a, 0x11} ,  // 0x78, x 
   {0x00, 0x00, 0x11, 0x11, 0x0f, 0x01, 0x11, 0x0e} ,  // 0x79, y 
   {0x00, 0x00, 0x00, 0x1f, 0x02, 0x04, 0x08, 0x1f} ,  // 0x7a, z 
   {0x00, 0x06, 0x08, 0x08, 0x10, 0x08, 0x08, 0x06} ,  // 0x7b, { 
   {0x00, 0x04, 0x04, 0x04, 0x00, 0x04, 0x04, 0x04} ,  // 0x7c, | 
   {0x00, 0x0c, 0x02, 0x02, 0x01, 0x02, 0x02, 0x0c} ,  // 0x7d, } 
   {0x00, 0x08, 0x15, 0x02, 0x00, 0x00, 0x00, 0x00} ,  // 0x7e, ~ 
   {0x00, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f} ,  // 0x7f, DEL 	// 127 ?????? ?? ASCII	// 95 ???????? ???????
      
   ////////  ??????? ???????  ///////////////////////////////////////////////////////////
	{0x00, 0x07, 0x09, 0x11, 0x1F, 0x11, 0x11, 0x11}, // ; ?		// 192 ?????? ?? ASCII  // 96 ???????? ???????
	{0x00, 0x1E, 0x10, 0x10, 0x1E, 0x11, 0x11, 0x1E}, // ; ?
	{0x00, 0x1E, 0x11, 0x11, 0x1E, 0x11, 0x11, 0x1E}, // ; ?
	{0x00, 0x1F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10}, // ; ?
	{0x00, 0x06, 0x0A, 0x0A, 0x0A, 0x0A, 0x1F, 0x11}, // ; ?
	{0x00, 0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x1F}, // ; ?
	{0x00, 0x15, 0x15, 0x15, 0x0E, 0x15, 0x15, 0x15}, // ; ?
	{0x00, 0x0E, 0x11, 0x02, 0x06, 0x01, 0x11, 0x0E}, // ; ?
	{0x00, 0x11, 0x11, 0x11, 0x13, 0x15, 0x19, 0x11}, // ; ?
	{0x00, 0x0A, 0x15, 0x11, 0x13, 0x15, 0x19, 0x11}, // ; ?
	{0x00, 0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11}, // ; ?
	{0x00, 0x03, 0x05, 0x09, 0x09, 0x09, 0x09, 0x11}, // ; ?
	{0x00, 0x11, 0x1B, 0x15, 0x11, 0x11, 0x11, 0x11}, // ; ?
	{0x00, 0x11, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11}, // ; ?
	{0x00, 0x0E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E}, // ; ?
	{0x00, 0x1F, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11}, // ; ?
	{0x00, 0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x10}, // ; ?
	{0x00, 0x0E, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0E}, // ; ?
	{0x00, 0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04}, // ; ?
	{0x00, 0x11, 0x11, 0x11, 0x0F, 0x01, 0x11, 0x0E}, // ; ?
	{0x00, 0x0E, 0x15, 0x15, 0x15, 0x0E, 0x04, 0x04}, // ; ?
	{0x00, 0x11, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x11}, // ; ?
	{0x00, 0x12, 0x12, 0x12, 0x12, 0x12, 0x1F, 0x01}, // ; ?
	{0x00, 0x11, 0x11, 0x11, 0x0F, 0x01, 0x01, 0x01}, // ; ?
	{0x00, 0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x1F}, // ; ?
	{0x00, 0x15, 0x15, 0x15, 0x15, 0x15, 0x1F, 0x01}, // ; ?
	{0x00, 0x18, 0x08, 0x08, 0x0E, 0x09, 0x09, 0x0E}, // ; ?
	{0x00, 0x11, 0x11, 0x11, 0x19, 0x15, 0x15, 0x19}, // ; ?
	{0x00, 0x10, 0x10, 0x10, 0x1E, 0x11, 0x11, 0x1E}, // ; ?
	{0x00, 0x0E, 0x11, 0x01, 0x0F, 0x01, 0x11, 0x0E}, // ; ?
	{0x00, 0x12, 0x15, 0x15, 0x1D, 0x15, 0x15, 0x12}, // ; ?
	{0x00, 0x0F, 0x11, 0x11, 0x0F, 0x05, 0x09, 0x11}, // ; ?
	{0x00, 0x00, 0x00, 0x0E, 0x12, 0x12, 0x12, 0x0D}, // ; ?
	{0x00, 0x01, 0x0E, 0x10, 0x0E, 0x11, 0x11, 0x0E}, // ; ?
	{0x00, 0x00, 0x00, 0x0E, 0x09, 0x0E, 0x09, 0x0E}, // ; ?
	{0x00, 0x00, 0x00, 0x0F, 0x08, 0x08, 0x08, 0x08}, // ; ?
	{0x00, 0x00, 0x00, 0x06, 0x0A, 0x0A, 0x1F, 0x11}, // ; ?
	{0x00, 0x00, 0x00, 0x0E, 0x11, 0x1F, 0x10, 0x0E}, // ; ?
	{0x00, 0x00, 0x00, 0x15, 0x15, 0x0E, 0x15, 0x15}, // ; ?
	{0x00, 0x00, 0x00, 0x0E, 0x01, 0x06, 0x01, 0x0E}, // ; ?
	{0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0D}, // ; ?
	{0x00, 0x00, 0x02, 0x15, 0x11, 0x11, 0x13, 0x0D}, // ; ?
	{0x00, 0x00, 0x00, 0x13, 0x14, 0x18, 0x14, 0x13}, // ; ?
	{0x00, 0x00, 0x00, 0x07, 0x09, 0x09, 0x09, 0x11}, // ; ?
	{0x00, 0x00, 0x00, 0x11, 0x1B, 0x15, 0x11, 0x11}, // ; ?
	{0x00, 0x00, 0x00, 0x11, 0x11, 0x1F, 0x11, 0x11}, // ; ?
	{0x00, 0x00, 0x00, 0x0E, 0x11, 0x11, 0x11, 0x0E}, // ; ?
	{0x00, 0x00, 0x00, 0x1F, 0x11, 0x11, 0x11, 0x11}, // ; ?
	{0x00, 0x00, 0x00, 0x1E, 0x11, 0x11, 0x1E, 0x10}, // ; ?
	{0x00, 0x00, 0x00, 0x0E, 0x11, 0x10, 0x11, 0x0E}, // ; ?
	{0x00, 0x00, 0x00, 0x1F, 0x04, 0x04, 0x04, 0x04}, // ; ?
	{0x00, 0x00, 0x00, 0x11, 0x11, 0x0F, 0x11, 0x0E}, // ; ?
	{0x00, 0x00, 0x04, 0x0E, 0x15, 0x0E, 0x04, 0x04}, // ; ?
	{0x00, 0x00, 0x00, 0x11, 0x0A, 0x04, 0x0A, 0x11}, // ; ?
	{0x00, 0x00, 0x00, 0x12, 0x12, 0x12, 0x1F, 0x01}, // ; ?
	{0x00, 0x00, 0x00, 0x11, 0x11, 0x0F, 0x01, 0x01}, // ; ?
	{0x00, 0x00, 0x00, 0x15, 0x15, 0x15, 0x15, 0x1F}, // ; ?
	{0x00, 0x00, 0x00, 0x15, 0x15, 0x15, 0x1F, 0x01}, // ; ?
	{0x00, 0x00, 0x00, 0x18, 0x08, 0x0E, 0x09, 0x0E}, // ; ?
	{0x00, 0x00, 0x00, 0x11, 0x11, 0x1D, 0x13, 0x1D}, // ; ?
	{0x00, 0x00, 0x00, 0x08, 0x08, 0x0E, 0x09, 0x0E}, // ; ?
	{0x00, 0x00, 0x00, 0x0E, 0x11, 0x07, 0x11, 0x0E}, // ; ?
	{0x00, 0x00, 0x00, 0x12, 0x15, 0x1D, 0x15, 0x12}, // ; ?
	{0x00, 0x00, 0x00, 0x0F, 0x11, 0x0F, 0x03, 0x0D},  // ; ?	// 255 ?????? ?? ASCII	// 159 ???????? ???????
	
	//////////  ???? ??????? ? ??????? ??????? ?? ???????? ? ????????? ???? ???????? ???????  //////////////
	
	////// ??????? ????? ? ? ? ????????  //// -------------------------------------------- 
  {0x00, 0x0A, 0x1F, 0x10, 0x1E, 0x10, 0x10, 0x1F}, // ; ? 	// 168 ?????? ?? ASCII  - 160 ???????? ???????
	{0x00, 0x0A, 0x00, 0x0E, 0x11, 0x1F, 0x10, 0x0E}  // ; ?	// 184 ?????? ?? ASCII  - 161 ???????? ???????
};  //   ????? MAX7219_Dot_Matrix_font

void max7219_init(const uint8_t br) {
    RCC->APB1ENR |= RCC_APB1ENR_SPI2EN;
    RCC->APB2ENR |= RCC_APB2ENR_IOPBEN;
	
    // SCK, MOSI
    GPIOB->CRH |= GPIO_CRH_MODE13;
    GPIOB->CRH &= ~GPIO_CRH_CNF13_0;
    GPIOB->CRH |=  GPIO_CRH_CNF13_1;
	
    GPIOB->CRH |= GPIO_CRH_MODE15;
    GPIOB->CRH &= ~GPIO_CRH_CNF15_0;
    GPIOB->CRH |=  GPIO_CRH_CNF15_1;
	
    // CS
    GPIOB->CRL |= GPIO_CRL_MODE5;
  	GPIOB->CRL &= ~GPIO_CRL_CNF5;
    CS_DIACTIVATE();
	
    SPI1->CR1 |= SPI_CR1_MSTR;      // master mode
    SPI1->CR1 |= SPI_CR1_BIDIMODE;  // 1 line
    SPI1->CR1 |= SPI_CR1_BIDIOE;    // MOSI
    SPI1->CR1 &= ~SPI_CR1_BR;       // spi_sck = SystemCoreClock / 16 = 8 MHz
    SPI1->CR1 |= SPI_CR1_BR_1;
    SPI1->CR1 &= ~SPI_CR1_LSBFIRST; // MSB
    SPI1->CR1 |= SPI_CR1_DFF;       // 16 bit format
    SPI1->CR1 |= SPI_CR1_SSI;       // software CS
    SPI1->CR1 &= ~SPI_CR1_CPHA;
    SPI1->CR1 &= ~SPI_CR1_CPOL;
		
    SPI1->I2SCFGR &= ~SPI_I2SCFGR_I2SMOD;
		
    SPI1->CR1 |= SPI_CR1_SPE;
		
    // set mode
    max7219_send_to_all(REG_SHUTDOWN,    0x01); // restart
    max7219_send_to_all(REG_DECODE_MODE, 0x00); // use normal mode
    max7219_send_to_all(REG_SCAN_LIMIT,  0x07); // use all lines
		
    max7219_set_brightness(br);
    max7219_clear();
}
__attribute__((always_inline)) static inline void send_data(uint8_t reg, uint8_t data) {
    SPI1->DR = (uint16_t)( (reg << 8) | data );
    while ( (SPI1->SR & SPI_SR_BSY) == SPI_SR_BSY){};
}

void max7219_send_to_all(const uint8_t reg, const uint8_t data)
{
    CS_ACTIVATE();
    for (uint32_t i = 0; i < MAX7219_CHIPS; i++) {
        send_data(reg, data);
    }
    CS_DIACTIVATE();
}

void max7219_send_to_chip(const uint8_t reg, const uint8_t data, const uint8_t chip) 
{
    if (chip > MAX7219_CHIPS) 
		{return;}
		
    CS_ACTIVATE();
    for (uint32_t i = 0; i < MAX7219_CHIPS; i++) {
        if ( (MAX7219_CHIPS - i - 1) == chip)
            send_data(reg, data);
        else
            send_data(REG_NO_OP, data);
    }
    CS_DIACTIVATE();
}

void max7219_send(const uint8_t reg, const uint8_t data_0, const uint8_t data_1) {
    CS_ACTIVATE();
    send_data(reg, data_0);
    send_data(reg, data_1);
    CS_DIACTIVATE();
}

void max7219_set_brightness(const uint8_t br) {
    max7219_send_to_all(REG_INTENSITY, br > 15 ? 15 : br);
}

void max7219_clear(void) {
    for (uint32_t i = 0; i < 8; i++) {
        max7219_send_to_all(REG_DIGIT_0 + i, 0x00);
    }
}

void max7219_send_8(const uint8_t data) {
	
	     for (uint32_t i = 0; i < 8; i++) {
        max7219_send_to_all(0x08  , data);
    }
}

void max7219_test(void) {
    max7219_send_to_all(REG_DIGIT_0, 0xff);
	HAL_Delay(1000);  
    max7219_send_to_all(REG_DIGIT_1, 0xff);
	HAL_Delay(1000);
    max7219_send_to_all(REG_DIGIT_2, 0xff);
	HAL_Delay(1000);
    max7219_send_to_all(REG_DIGIT_3, 0xff);
	HAL_Delay(1000);
    max7219_send_to_all(REG_DIGIT_4, 0xff);
	HAL_Delay(1000);
    max7219_send_to_all(REG_DIGIT_5, 0xff);
	HAL_Delay(1000);
    max7219_send_to_all(REG_DIGIT_6, 0xff);
	HAL_Delay(1000);
    max7219_send_to_all(0x08, 0xff);
	HAL_Delay(1000);
}


//void max7219_SetStrirg(char* text, int x, int y)
//{
//	uint8_t i,move = 0;
//	uint16_t setPixel = 0;
//	x = MAX7219_CHIPS*8;
//  uint16_t len = strlen(text);	
//  uint16_t count_len =0;
//	while( len-- )
//	{
//		uint8_t c = (uint8_t)text[count_len];	
//		count_len++;  
//	
//		if( c > 31 && c < 128 ) { c = c - 32; }
//		else if( c >  191)      { c = c - 96; }
//		else if( c == 168)      { c = c - 8;  }		// 168 - 160 ???????? ??????? ( ?????? ? ) = 8
//		else if( c == 184)      { c = c - 23; }		// 184 - 161 ???????? ??????? ( ?????? ? ) = 23
//	
//		DataNamChar[i] = c;
//		i++;
//	}
//	
//	while(1)
//	{
//		for(int j=4; j>=0; j++)
//		{
//			setPixel = MAX7219_Matrix_font[DataNamChar[move]][move]>>j;
//			for(int reg=0; reg<8; reg++)
//			max7219_send(reg, setPixel, setPixel);
//			HAL_Delay(500);
//		}
//		uint16_t setPixel = DataNamChar[i];
//		move++;
//    // stop if char is outside visible area 
//		//MAX7219_Matrix_font[c][i-1]
//}
//}




///  https://github.com/GolinskiyKonstantin/STM32_Lib_MAX7219_Matrix_8x8/blob/main/MAX7219/MAX7219.c
